{% extends "shop/shop_base.html" %}
{% load bootstrap4 wagtailimages_tags shop_tags static django_htmx %}
{% block body_class %}bg-guest-light{% endblock %}
{% block content_body %}

  <div class="container-fluid my-2 py-2 bg-light">
    <div class="row">
      <div class="col">
        {% if item %}
          <div class="h4 py-2">Edit Item Ref: {{ item.ref }}</div>
        {% else %}
          <div class="h4">New item</div>
        {% endif %}
      </div>
    </div>

    <form method="post" action="{{ path }}" class="js-form">
      {% csrf_token %}
      <input type="hidden" id="pk" name="pk" value="{{ object.pk }}">
      {% bootstrap_messages %}
      {% if form.errors %}<p class="text-danger">Please correct the errors on this form.</p>{% endif %}
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <div class="row">
            <div class="col-lg-6">
              {% if object %}
                <div class="card bg-transparent">
                  {% if object.image %}
                    {% image object.image width-250 as card_image %}
                    <img class="card-img-top" src="{{ card_image.url }}">
                  {% endif %}
                  <div class="p-2">
                    {% if object and not object.image %}
                      <div class=" p-2 text-center">
                        <i>No image</i>
                      </div>
                    {% endif %}
                    <a class="btn btn-secondary btn-sm btn-block m-0" href="{% url 'item_images' pk=object.pk %}">Manage
                      images</a>
                  </div>
                </div>
              {% else %}
                <p>You can add images after the item has been saved</p>
              {% endif %}
            </div>
            <div class="col-lg-6 pl-0">
              <div class="card card-body">
                <h5>Key settings</h5>
                {% bootstrap_field form.state show_label=False %}
                {% bootstrap_field form.rank %}
                {% checkbox form.visible %}
                {% if not object.archive %}
                  {% checkbox form.featured %}
                  {% checkbox form.show_price %}
                  {% checkbox form.done %}
                {% endif %}
              </div>
            </div>
          </div>
          {% bootstrap_field form.category %}
          <div class="card card-body bg-light py-1 border-dark">
            {% if object.archive %}
              <fieldset disabled>
              <legend>Archived item</legend>
            {% else %}
              <fieldset>
              <legend>Stock item</legend>
            {% endif %}
            {% if item.lot %}
              <p>Vendor: {{ item.lot.purchase.vendor.company }}<br>
                Purchased on {{ item.lot.purchase.date|date }}</p>
            {% else %}
              <p> Purchase details unknown</p>
            {% endif %}
            <table>
              {% if form.location %}
                <tr>
                  <td style="width: 140px;">{% bootstrap_label "Location" %}</td>
                  <td colspan="3">{% bootstrap_field form.location show_label=False %}</td>
                </tr>
              {% endif %}
              <tr>
                <td style="width: 140px;"><label>Purchase cost</label></td>
                <td>{% currency_field form.cost_price %}</td>
              </tr>
              <tr>
                <td style="width: 140px;">Restoration cost</td>
                <td>{% currency_field form.restoration_cost %}</td>
              </tr>
              <tr>
                <td style="width: 140px;" class="label">Total cost</td>
                {#              <td>Â£ <input type="number" name="total_cost" id="id_total_cost" class="cell" readonly></td>#}
                <td>{% currency_field form.total_cost %}</td>
              </tr>
              {% if form.sale_price %}
                <tr class="mt-3">
                  <td style="width: 140px;">Sale price</td>
                  <td> {% currency_field form.sale_price %}</td>
                  <td>
                  <td class="small"><span id="id_margin"></span></td>
                </tr>
              {% endif %}
              {% if form.minimum_price %}
                <tr>
                  <td style="width: 140px;">Minimum price</td>
                  <td>{% currency_field form.minimum_price %}</td>
                  <td></td>
                  <td class="small"><span id="id_min_margin"></span></td>
                </tr>
              {% endif %}
            </table>

            {% if object.archive %}</fieldset>{% endif %}
            </fieldset>
          </div>
        </div>
        <div class="col-md-6 col-lg-8">
          {% if not object %} {% bootstrap_field form.ref %} {% endif %}
          {% bootstrap_field form.name %}
          {% bootstrap_field form.description %}
          {% bootstrap_field form.condition %}
          {% bootstrap_field form.dimensions %}
          {% bootstrap_field form.provenance %}
          {% bootstrap_field form.notes %}
          {% bootstrap_field form.book %}

        </div>
      </div>

      <div class="row bg-white mt-2 border-top">
        <div class="col mt-2">
          {% if modal %}
            <button class="btn btn-default" data-dismiss="modal">Cancel</button>
          {% elif object %}
            <a class="btn btn-default" href={% url 'item_detail' pk=object.pk %}>Cancel</a>
          {% endif %}
          {% if allow_delete %}
            <button class="btn btn-danger" {% if modal %}type="button" data-toggle="modal" data-target="#modal-confirm"
                    {% else %}type="submit" name="delete"{% endif %}>Delete
            </button>
          {% endif %}
          <button type="submit" class="btn btn-secondary"  name="save">Save</button>
          <button type="submit" class="btn btn-secondary"  name="preview">Preview</button>
          <button type="submit" class="btn btn-secondary float-right" name="add">Add to cart</button>
        </div>
      </div>
    </form>
    <script src="/static/shop/js/jquery.inputmask.min.js"></script>
    <script src="/static/shop/js/inputmask.binding.js"></script>
    <script src="{% static 'shop/js/margin_calc.js' %}"></script>
    <script>
      $('body').on('keydown', 'input, select', function (e) {
        if (e.key === "Enter") {
          var self = $(this), form = self.parents('form:eq(0)'), focusable, next;
          focusable = form.find('input,a,select,button,textarea').filter(':visible');
          next = focusable.eq(focusable.index(this) + 1);
          if (next.length) {
            next.focus();
          } else {
            form.submit();
          }
          return false;
        }
      });
      margin_calc();
      $('.cell').change(function () {
        margin_calc();
      });
    </script>
  </div>
  <div id="modals-here"></div>
{% endblock %}

